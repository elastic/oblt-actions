name: test-download-kibana-dashboard

on:
  merge_group: ~
  workflow_dispatch: ~
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/test-download-kibana-dashboard.yml'
      - 'download-kibana-dashboard/**'
  push:
    branches:
      - main
    paths:
      - '.github/workflows/test-download-kibana-dashboard.yml'
      - 'download-kibana-dashboard/**'

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:

      # Using OIDC and the oblt-cli to get cluster credentials
      - uses: elastic/oblt-actions/google/auth@v1
        if: ${{ github.event_name != 'merge_group' }}

      - name: Get token
        if: ${{ github.event_name != 'merge_group' }}
        id: get_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.OBS_AUTOMATION_APP_ID }}
          private-key: ${{ secrets.OBS_AUTOMATION_APP_PEM }}
          permission-contents: read
          repositories: |
            observability-test-environments

      - uses: elastic/oblt-actions/oblt-cli/cluster-credentials@v1
        if: ${{ github.event_name != 'merge_group' }}
        with:
          github-token: ${{ steps.get_token.outputs.token }}
          cluster-name: 'dev-oblt'

      - uses: actions/checkout@v5

      - uses: ./download-kibana-dashboard
        if: ${{ github.event_name != 'merge_group' }}
        with:
          kibana-host: ${{ env.KIBANA_HOST }}
          kibana-user: ${{ env.KIBANA_USERNAME }}
          kibana-password: ${{ env.KIBANA_PASSWORD }}
          dashboard-id: "2c0daa02-35e8-4dd3-aa0a-6a24a48d857d"
